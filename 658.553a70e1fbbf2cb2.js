"use strict";(self.webpackChunkdemo=self.webpackChunkdemo||[]).push([[658],{7879:(lt,z,f)=>{f.d(z,{Be:()=>kt,Bn:()=>mt,GF:()=>et,Mt:()=>O,RZ:()=>V,Sb:()=>ht,YO:()=>x,bO:()=>ct,i$:()=>j,wM:()=>r});const O="selectorGroup",r="svgroot",V="item_",j="selectorBox",x="selectorGrip_",ht="selectorGrip_resize",kt="selectorGrip_rotate",et=1e3,mt="data-wb-id",ct={high:3,normal:2,low:1}},3052:(lt,z,f)=>{f.d(z,{X:()=>O});var O=function(r){return r.Save="save",r.Undo="undo",r.Redo="redo",r.Clear="clear",r.AddImage="addImage",r.ToggleGrid="toggleGrid",r.AddElement="addElement",r.UpdateElement="updateElement",r.RemoveElements="removeElements",r.SelectElements="selectElements",r.ToggleSelection="toggleSelection",r.DeselectElement="deselectElement",r.SelectAll="selectAll",r.ClearSelection="clearSelection",r.UpdateSelectedElements="updateSelectedElements",r.SetActiveTool="setActiveTool",r.SetCanvasDimensions="setCanvasDimensions",r.SetCanvasPosition="setCanvasPosition",r.UpdateGridTranslation="updateGridTranslation",r.UpdateElementsTranslation="updateElementsTranslation",r.FullScreen="fullScreen",r.CenterCanvas="centerCanvas",r.Batch="batch",r}(O||{})},2262:(lt,z,f)=>{f.d(z,{R:()=>O});var O=function(r){return r.Pen="pen",r.Rectangle="rectangle",r.Ellipse="ellipse",r.Line="line",r.Arrow="arrow",r.Text="text",r.Image="image",r}(O||{})},872:(lt,z,f)=>{f.d(z,{p:()=>O});var O=function(r){return r.Hand="hand",r.Select="select",r.Pen="pen",r.Rectangle="rectangle",r.Image="image",r.Line="line",r.Arrow="arrow",r.Ellipse="ellipse",r.Text="text",r.Eraser="eraser",r}(O||{})},6078:(lt,z,f)=>{f.d(z,{$3:()=>r,OP:()=>j,o8:()=>O,pP:()=>V});var O=function(x){return x.Png="png",x.Jpeg="jpeg",x.Svg="svg",x.Base64="base64",x}(O||{}),r=function(x){return x.Round="round",x.Butt="butt",x.Square="square",x}(r||{}),V=function(x){return x.Round="round",x.Miter="miter",x.Bevel="bevel",x.MiterClip="miter-clip",x}(V||{}),j=function(x){return x.NW="nw",x.N="n",x.NE="ne",x.E="e",x.SE="se",x.S="s",x.SW="sw",x.W="w",x}(j||{})},2658:(lt,z,f)=>{f.d(z,{I:()=>_i});var O=f(177),r=f(4438),V=f(1985),j=f(6977);function x(n){n||((0,r.Af3)(x),n=(0,r.WQX)(r.abz));const e=new V.c(t=>n.onDestroy(t.next.bind(t)));return t=>t.pipe((0,j.Q)(e))}var it=f(8141),Tt=f(5964),w=f(3052),qt=f(4523),J=f(4412),Bt=f(4572),zt=f(9974);const{isArray:Nt}=Array;function b(n){return 1===n.length&&Nt(n[0])?n[0]:n}var Ut=f(6450),Yt=f(1203),Gt=f(3794);function Dt(...n){const e=(0,Gt.ms)(n);return e?(0,Yt.F)(Dt(...n),(0,Ut.I)(e)):(0,zt.N)((t,i)=>{(0,Bt.P)([t,...b(n)])(i)})}function I(...n){return Dt(...n)}var m=f(6354),c=f(7879),d=f(2262),g=f(6078);const B={strokeWidth:2,strokeColor:"#000000",fill:"#000000",lineJoin:g.pP.Miter,lineCap:g.$3.Butt,dasharray:"",dashoffset:0},Q={...B,fontSize:14,fontFamily:"Arial",fontStyle:"normal",fontWeight:"normal",color:"#000000"};function Y(){return Math.random().toString(36).substring(2).padEnd(12,"0").substring(0,12)}const G=1e-6;function pt(n,e){return Math.atan2(e.y-n.y,e.x-n.x)*(180/Math.PI)}function dt(n){return(n%=360)<0?n+360:n}function nt(n,e){return Math.abs(n)>Math.abs(e)?{x:n,y:0}:{x:0,y:e}}function _(n,e,t,i){const s=t.x,o=t.y,a=i.x,l=i.y,h=(a-s)**2+(l-o)**2;if(0===h)return Math.sqrt((n-s)**2+(e-o)**2);let u=((n-s)*(a-s)+(e-o)*(l-o))/h;return u=Math.max(0,Math.min(1,u)),Math.sqrt((n-(s+u*(a-s)))**2+(e-(o+u*(l-o)))**2)}function ut(n,e,t,i,s=G){const o=(S,P)=>S.x*P.y-S.y*P.x,a=(S,P)=>({x:S.x-P.x,y:S.y-P.y}),l=a(e,n),h=a(i,t),u=a(t,n),p=o(l,h),v=o(u,l);if(Math.abs(p)<s){if(Math.abs(v)>=s)return!1;const S=l.x*l.x+l.y*l.y,P=(u.x*l.x+u.y*l.y)/S,K=a(i,n),rt=(K.x*l.x+K.y*l.y)/S;return P>=0&&P<=1||rt>=0&&rt<=1||P<0&&rt>1||P>1&&rt<0}const R=v/p,k=o(u,h)/p;return R>=0&&R<=1&&k>=0&&k<=1}function Wt(n,e,t,i){const s=[[{x:n.minX,y:n.minY},{x:n.maxX,y:n.minY}],[{x:n.maxX,y:n.minY},{x:n.maxX,y:n.maxY}],[{x:n.maxX,y:n.maxY},{x:n.minX,y:n.maxY}],[{x:n.minX,y:n.maxY},{x:n.minX,y:n.minY}]];for(const[o,a]of s)if(ut(e,t,o,a,i))return!0;return!1}function te(n,e,t,i,s,o,a){const l={x:n,y:e},h={x:t,y:i};return _(s.x,s.y,l,h)<=a||_(o.x,o.y,l,h)<=a}function ee(n,e,t,i=(s=>s)){return n*i(.5-e*(.5-t))}function W(n,e){return[n[0]+e[0],n[1]+e[1]]}function U(n,e){return[n[0]-e[0],n[1]-e[1]]}function $(n,e){return[n[0]*e,n[1]*e]}function vt(n){return[n[1],-n[0]]}function ie(n,e){return n[0]*e[0]+n[1]*e[1]}function Oe(n,e){return n[0]===e[0]&&n[1]===e[1]}function ne(n,e){return function Xe(n){return n[0]*n[0]+n[1]*n[1]}(U(n,e))}function se(n){return function Re(n,e){return[n[0]/e,n[1]/e]}(n,function Ie(n){return Math.hypot(n[0],n[1])}(n))}function _e(n,e){return Math.hypot(n[1]-e[1],n[0]-e[0])}function xt(n,e,t){let i=Math.sin(t),s=Math.cos(t),o=n[0]-e[0],a=n[1]-e[1];return[o*s-a*i+e[0],o*i+a*s+e[1]]}function $t(n,e,t){return W(n,$(U(e,n),t))}function re(n,e,t){return W(n,$(e,t))}var{min:gt,PI:Ae}=Math,St=Ae+1e-4;const Ge={size:1,smoothing:1,thinning:0,streamline:1};function Ft(n,e=1){return function We(n,e=!0){const t=n.length;if(t<4)return"";let i=n[0],s=n[1];const o=n[2];let a=`M${i[0].toFixed(2)},${i[1].toFixed(2)} Q${s[0].toFixed(2)},${s[1].toFixed(2)} ${((s[0]+o[0])/2).toFixed(2)},${((s[1]+o[1])/2).toFixed(2)} T`;for(let l=2,h=t-1;l<h;l++)i=n[l],s=n[l+1],a+=`${((i[0]+s[0])/2).toFixed(2)},${((i[1]+s[1])/2).toFixed(2)} `;return e&&(a+="Z"),a}(function Ue(n,e={}){return function ze(n,e={}){let{size:t=16,smoothing:i=.5,thinning:s=.5,simulatePressure:o=!0,easing:a=(C=>C),start:l={},end:h={},last:u=!1}=e,{cap:p=!0,easing:v=(C=>C*(2-C))}=l,{cap:R=!0,easing:k=(C=>--C*C*C+1)}=h;if(0===n.length||t<=0)return[];let Vt,S=n[n.length-1].runningLength,P=!1===l.taper?0:!0===l.taper?Math.max(t,S):l.taper,K=!1===h.taper?0:!0===h.taper?Math.max(t,S):h.taper,rt=Math.pow(t*i,2),bt=[],ft=[],Ht=n.slice(0,10).reduce((C,X)=>{let E=X.pressure;if(o){let T=gt(1,X.distance/t),Qt=gt(1,1-T);E=gt(1,C+.275*T*(Qt-C))}return(C+E)/2},n[0].pressure),A=ee(t,s,n[n.length-1].pressure,a),Lt=n[0].vector,Pt=n[0].point,Xt=Pt,ot=Pt,at=Xt,jt=!1;for(let C=0;C<n.length;C++){let{pressure:X}=n[C],{point:E,vector:T,distance:Qt,runningLength:Mt}=n[C];if(C<n.length-1&&S-Mt<3)continue;if(s){if(o){let tt=gt(1,Qt/t),Zt=gt(1,1-tt);X=gt(1,Ht+.275*tt*(Zt-Ht))}A=ee(t,s,X,a)}else A=t/2;void 0===Vt&&(Vt=A);let Ai=Mt<P?v(Mt/P):1,zi=S-Mt<K?k((S-Mt)/K):1;A=Math.max(.01,A*Math.min(Ai,zi));let Ce=(C<n.length-1?n[C+1]:n[C]).vector,Kt=C<n.length-1?ie(T,Ce):1,we=null!==Kt&&Kt<0;if(ie(T,Lt)<0&&!jt||we){let tt=$(vt(Lt),A);for(let Zt=1/13,At=0;At<=1;At+=Zt)ot=xt(U(E,tt),E,St*At),bt.push(ot),at=xt(W(E,tt),E,St*-At),ft.push(at);Pt=ot,Xt=at,we&&(jt=!0);continue}if(jt=!1,C===n.length-1){let tt=$(vt(T),A);bt.push(U(E,tt)),ft.push(W(E,tt));continue}let Ee=$(vt($t(Ce,T,Kt)),A);ot=U(E,Ee),(C<=1||ne(Pt,ot)>rt)&&(bt.push(ot),Pt=ot),at=W(E,Ee),(C<=1||ne(Xt,at)>rt)&&(ft.push(at),Xt=at),Ht=X,Lt=T}let Z=n[0].point.slice(0,2),q=n.length>1?n[n.length-1].point.slice(0,2):W(n[0].point,[1,1]),Jt=[],_t=[];if(1===n.length){if(!P&&!K||u){let C=re(Z,se(vt(U(Z,q))),-(Vt||A)),X=[];for(let E=1/13,T=E;T<=1;T+=E)X.push(xt(C,Z,2*St*T));return X}}else{if(!(P||K&&1===n.length))if(p)for(let X=1/13,E=X;E<=1;E+=X){let T=xt(ft[0],Z,St*E);Jt.push(T)}else{let X=U(bt[0],ft[0]),E=$(X,.5),T=$(X,.51);Jt.push(U(Z,E),U(Z,T),W(Z,T),W(Z,E))}let C=vt(function De(n){return[-n[0],-n[1]]}(n[n.length-1].vector));if(K||P&&1===n.length)_t.push(q);else if(R){let X=re(q,C,A);for(let E=1/29,T=E;T<1;T+=E)_t.push(xt(X,q,3*St*T))}else _t.push(W(q,$(C,A)),W(q,$(C,.99*A)),U(q,$(C,.99*A)),U(q,$(C,A)))}return bt.concat(_t,ft.reverse(),Jt)}(function Ne(n,e={}){var t;let{streamline:i=.5,size:s=16,last:o=!1}=e;if(0===n.length)return[];let a=.15+.85*(1-i),l=Array.isArray(n[0])?n:n.map(({x:k,y:S,pressure:P=.5})=>[k,S,P]);if(2===l.length){let k=l[1];l=l.slice(0,-1);for(let S=1;S<5;S++)l.push($t(l[0],k,S/4))}1===l.length&&(l=[...l,[...W(l[0],[1,1]),...l[0].slice(2)]]);let h=[{point:[l[0][0],l[0][1]],pressure:l[0][2]>=0?l[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],u=!1,p=0,v=h[0],R=l.length-1;for(let k=1;k<l.length;k++){let S=o&&k===R?l[k].slice(0,2):$t(v.point,l[k],a);if(Oe(v.point,S))continue;let P=_e(S,v.point);if(p+=P,k<R&&!u){if(p<s)continue;u=!0}v={point:S,pressure:l[k][2]>=0?l[k][2]:.5,vector:se(U(v.point,S)),distance:P,runningLength:p},h.push(v)}return h[0].vector=(null==(t=h[1])?void 0:t.vector)||[0,0],h}(n,e),e)}(n,{...Ge,size:e}))}function ae(n){let e=1/0,t=1/0,i=-1/0,s=-1/0;for(const[o,a]of n)e=Math.min(e,o),t=Math.min(t,a),i=Math.max(i,o),s=Math.max(s,a);return{minX:e,minY:t,maxX:i,maxY:s,width:i-e,height:s-t}}function $e(n,e,t,i){return n.minX-i<=Math.max(e.x,t.x)&&n.maxX+i>=Math.min(e.x,t.x)&&n.minY-i<=Math.max(e.y,t.y)&&n.maxY+i>=Math.min(e.y,t.y)}const le={[d.R.Arrow]:new class Me{create(e){return{type:d.R.Arrow,id:Y(),x:0,y:0,x1:0,y1:0,x2:0,y2:0,rotation:0,opacity:100,...e,style:{...B,...e.style}}}resize(e,t,i,s){return t.includes(g.OP.N)&&(e.y2+=s),t.includes(g.OP.S)&&(e.y1+=s),t.includes(g.OP.W)&&(e.x1+=i),t.includes(g.OP.E)&&(e.x2+=i),e}getBounds(e){const t=e.x1+e.x,i=e.y1+e.y,s=e.x2+e.x,o=e.y2+e.y;return{minX:Math.min(t,s),minY:Math.min(i,o),maxX:Math.max(t,s),maxY:Math.max(i,o),width:Math.abs(s-t),height:Math.abs(o-i)}}hitTest(e,t,i,s){const{x1:o,y1:a,x2:l,y2:h}=e;return te(o,a,l,h,t,i,s)}},[d.R.Ellipse]:new class ke{create(e){return{type:d.R.Ellipse,id:Y(),x:0,y:0,cx:0,cy:0,rx:1,ry:1,rotation:0,opacity:100,...e,style:{...B,...e.style}}}resize(e,t,i,s){if(t.includes(g.OP.N)){const o=e.ry-s/2;o>0&&(e.ry=o,e.cy+=s/2)}if(t.includes(g.OP.S)){const o=e.ry+s/2;o>0&&(e.ry=o,e.cy+=s/2)}if(t.includes(g.OP.W)){const o=e.rx-i/2;o>0&&(e.rx=o,e.cx+=i/2)}if(t.includes(g.OP.E)){const o=e.rx+i/2;o>0&&(e.rx=o,e.cx+=i/2)}return e}getBounds(e){const t=e.cx+e.x,i=e.cy+e.y;return{minX:t-e.rx,minY:i-e.ry,maxX:t+e.rx,maxY:i+e.ry,width:2*e.rx,height:2*e.ry}}hitTest(e,t,i,s){const{cx:o,cy:a,rx:l,ry:h}=e;return function be(n,e,t,i,s,o,a){return _(n,e,s,o)<=Math.max(t,i)+a}(o,a,l,h,t,i,s)}},[d.R.Image]:new class Te{create(e){return{type:d.R.Image,id:Y(),x:0,y:0,width:1,height:1,src:"",rotation:0,opacity:100,...e,style:{...B,...e.style}}}resize(e,t,i,s){if(t.includes(g.OP.N)){const o=e.height-s;o>0&&(e.y+=s,e.height=o)}if(t.includes(g.OP.S)){const o=e.height+s;o>0&&(e.height=o)}if(t.includes(g.OP.W)){const o=e.width-i;o>0&&(e.x+=i,e.width=o)}if(t.includes(g.OP.E)){const o=e.width+i;o>0&&(e.width=o)}return e}getBounds(e){return{minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height,width:e.width,height:e.height}}hitTest(e,t,i,s){return Wt(this.getBounds(e),t,i,s)}},[d.R.Line]:new class Be{create(e){return{type:d.R.Line,id:Y(),x:0,y:0,x1:0,y1:0,x2:0,y2:0,rotation:0,opacity:100,...e,style:{...B,...e.style}}}resize(e,t,i,s){return t.includes(g.OP.N)&&(e.y1+=s),t.includes(g.OP.S)&&(e.y2+=s),t.includes(g.OP.W)&&(e.x1+=i),t.includes(g.OP.E)&&(e.x2+=i),e}getBounds(e){const t=e.x1+e.x,i=e.y1+e.y,s=e.x2+e.x,o=e.y2+e.y;return{minX:Math.min(t,s),minY:Math.min(i,o),maxX:Math.max(t,s),maxY:Math.max(i,o),width:Math.abs(s-t),height:Math.abs(o-i)}}hitTest(e,t,i,s){const{x1:o,y1:a,x2:l,y2:h}=e;return te(o,a,l,h,t,i,s)}},[d.R.Pen]:new class Fe{create(e){return{type:d.R.Pen,id:Y(),x:0,y:0,points:[],path:"",rotation:0,opacity:100,...e,style:{...B,...e.style}}}resize(e,t,i,s){const o=ae(e.points),{points:a,position:l}=this.getScaleFactors(t,o,i,s),h=o.minX+o.width/2,u=o.minY+o.height/2,[p,v]=a;return o.width*p<10||o.height*v<10||(e.x+=l.x,e.y+=l.y,e.points=e.points.map(R=>[h+(R[0]-h)*p,u+(R[1]-u)*v]),e.path=Ft(e.points)),e}getScaleFactors(e,t,i,s){const o=[1,1],a={x:0,y:0};return e.includes("w")&&(o[0]=(t.width-i)/t.width,a.x+=i/2),e.includes("n")&&(o[1]=(t.height-s)/t.height,a.y+=s/2),e.includes("e")&&(o[0]=(t.width+i)/t.width,a.x+=i/2),e.includes("s")&&(o[1]=(t.height+s)/t.height,a.y+=s/2),{points:o,position:a}}getBounds(e){const{minX:t,minY:i,maxX:s,maxY:o,width:a,height:l}=ae(e.points);return{minX:t+e.x,minY:i+e.y,maxX:s+e.x,maxY:o+e.y,width:a,height:l}}hitTest(e,t,i,s){return function Pe(n,e,t,i){for(let s=0;s<n.length-1;s++){const o={x:n[s][0],y:n[s][1]},a={x:n[s+1][0],y:n[s+1][1]};if(_(e.x,e.y,o,a)<=i||_(t.x,t.y,o,a)<=i)return!0}return!1}(e.points,t,i,s)}},[d.R.Rectangle]:new class He{create(e){return{type:d.R.Rectangle,id:Y(),x:0,y:0,width:1,height:1,rx:5,rotation:0,opacity:100,...e,style:{...B,...e.style}}}resize(e,t,i,s){if(t.includes(g.OP.N)){const o=e.height-s;o>0&&(e.y+=s,e.height=o)}if(t.includes(g.OP.S)){const o=e.height+s;o>0&&(e.height=o)}if(t.includes(g.OP.W)){const o=e.width-i;o>0&&(e.x+=i,e.width=o)}if(t.includes(g.OP.E)){const o=e.width+i;o>0&&(e.width=o)}return e}getBounds(e){return{minX:e.x,minY:e.y,maxX:e.x+e.width,maxY:e.y+e.height,width:e.width,height:e.height}}hitTest(e,t,i,s){return Wt(this.getBounds(e),t,i,s)}},[d.R.Text]:new class Ve{create(e){return{type:d.R.Text,id:Y(),x:0,y:0,text:"",rotation:0,opacity:100,scaleX:1,scaleY:1,...e,style:{...Q,...e.style}}}resize(e,t,i,s){const l=.016*i,h=.016*s;switch(t){case g.OP.NW:e.x+=i,e.y+=s,e.scaleX=Math.max(.1,e.scaleX-l),e.scaleY=Math.max(.1,e.scaleY-h);break;case g.OP.N:e.y+=s,e.scaleY=Math.max(.1,e.scaleY-h);break;case g.OP.NE:e.y+=s,e.scaleX=Math.max(.1,e.scaleX+l),e.scaleY=Math.max(.1,e.scaleY-h);break;case g.OP.E:e.scaleX=Math.max(.1,e.scaleX+l);break;case g.OP.SE:e.scaleX=Math.max(.1,e.scaleX+l),e.scaleY=Math.max(.1,e.scaleY+h);break;case g.OP.S:e.scaleY=Math.max(.1,e.scaleY+h);break;case g.OP.SW:e.x+=i,e.scaleX=Math.max(.1,e.scaleX-l),e.scaleY=Math.max(.1,e.scaleY+h);break;case g.OP.W:e.x+=i,e.scaleX=Math.max(.1,e.scaleX-l)}return e}getBounds(e){const{text:t,x:i,y:s,scaleX:o,scaleY:a,style:l}=e,h=l.fontSize??Q.fontSize??16,u=.5*h,p=t.split("\n"),R=u*p.reduce((S,P)=>Math.max(S,P.length),0)*o,k=h*p.length*a;return{minX:i,minY:s,maxX:i+R,maxY:s+k,width:R,height:k}}hitTest(e,t,i,s){return Wt(this.getBounds(e),t,i,s)}}};function Ct(n){return le[n]}function st(n,e){return le[n].create(e)}var M=f(872),y=function(n){return n.Ready="ready",n.Destroyed="destroyed",n.DrawStart="drawStart",n.Drawing="drawing",n.DrawEnd="drawEnd",n.ElementsAdded="elementsAdded",n.ElementsUpdated="elementsUpdated",n.ElementsSelected="elementsSelected",n.ElementsDeleted="elementsDeleted",n.Undo="undo",n.Redo="redo",n.Clear="clear",n.DataChange="dataChange",n.Save="save",n.ImageAdded="imageAdded",n.ToolChange="toolChange",n.ConfigChange="configChange",n}(y||{});function he(n,e){const t=document.createElement("a");t.href=n,t.setAttribute("visibility","hidden"),t.download=e||"new white-board",document.body.appendChild(t),t.click(),document.body.removeChild(t)}function je(n){return Ct(n.type).getBounds(n)}var Ot=f(1413);let wt=(()=>{class n{constructor(){this.eventSubject=new Ot.B}ngOnDestroy(){this.destroy()}emit(t,i){this.eventSubject.next({type:t,payload:i})}listen(){return this.eventSubject.asObservable()}listenTo(t){return this.eventSubject.pipe((0,Tt.p)(i=>i.type===t),(0,m.T)(i=>i.payload))}destroy(){this.eventSubject.complete()}static{this.\u0275fac=function(i){return new(i||n)}}static{this.\u0275prov=r.jDH({token:n,factory:n.\u0275fac})}}return n})(),It=(()=>{class n{constructor(t){this.eventBusService=t,this.config={drawingEnabled:!0,canvasWidth:800,canvasHeight:600,fullScreen:!0,center:!0,strokeColor:"#333333",strokeWidth:2,backgroundColor:"#F8F9FA",lineJoin:g.pP.Miter,lineCap:g.$3.Butt,fill:"transparent",zoom:1,fontFamily:"sans-serif",fontSize:24,dasharray:"",dashoffset:0,x:0,y:0,enableGrid:!1,gridSize:10,snapToGrid:!0,gridTranslation:{x:0,y:0},elementsTranslation:{x:0,y:0}}}getConfig(){return{...this.config}}updateConfig(t){this.config={...this.config,...t},this.eventBusService.emit(y.ConfigChange,t)}isConfigDifferent(t,i){return this.config[t]!==i}updateConfigValue(t,i){this.config[t]=i,this.eventBusService.emit(y.ConfigChange,{[t]:i})}checkAndUpdateConfig(t,i){this.isConfigDifferent(t,i)&&this.updateConfigValue(t,i)}static{this.\u0275fac=function(i){return new(i||n)(r.KVO(wt))}}static{this.\u0275prov=r.jDH({token:n,factory:n.\u0275fac})}}return n})(),Et=(()=>{class n{constructor(t,i,s){this.EventBusService=t,this.configService=i,this.undoStack=[],this.redoStack=[],this.initialData=[],this.data=new J.t([]),this.draftData=new J.t([]),this.selectedTool=new J.t(M.p.Pen),this.selectedElementIds=new J.t(new Set),this.selectionBox=new J.t({x:0,y:0,width:0,height:0,visible:!1}),this.boundingBox=new J.t(null),this.svgContainer=null,this.data$=this.data.pipe(I(this.draftData),(0,m.T)(([o,a])=>[...o,...a])),this.selectedTool$=this.selectedTool.asObservable(),this.selectionBox$=this.selectionBox.asObservable(),this.boundingBox$=this.boundingBox.asObservable(),this.debouncedPushToUndo=function Le(n,e){let t;return(...i)=>{clearTimeout(t),t=setTimeout(()=>n(...i),e)}}(()=>this.pushToUndo(),300),this.renderer=s.createRenderer(null,null)}initializeWhiteboard(t){this.svgContainer=t,this.initialData=JSON.parse(JSON.stringify(this.data.getValue())),this.EventBusService.emit(y.Ready)}getCanvas(){if(!this.svgContainer)throw new Error("SVG container not initialized");return this.svgContainer}getConfig(){return this.configService.getConfig()}getData(){return this.data.getValue()}getData$(){return this.data$}getElementById(t){return this.getData().find(i=>i.id===t)}setData(t){this.data.next(t),this.EventBusService.emit(y.DataChange,t)}getDraftData(){return this.draftData.getValue()}pushToUndo(){this.undoStack.push(JSON.parse(JSON.stringify(this.getData()))),this.undoStack.length>c.GF&&this.undoStack.shift(),this.redoStack=[]}undo(){if(!this.undoStack.length)return!1;const t=this.undoStack.pop();return this.redoStack.push(t),this.setData(this.undoStack.length?JSON.parse(JSON.stringify(this.undoStack[this.undoStack.length-1])):JSON.parse(JSON.stringify(this.initialData))),this.clearSelection(),this.EventBusService.emit(y.Undo),!0}redo(){if(!this.redoStack.length)return!1;const t=this.redoStack.pop();return this.undoStack.push(JSON.parse(JSON.stringify(t))),this.undoStack.length>c.GF&&this.undoStack.shift(),this.setData(t),this.clearSelection(),this.EventBusService.emit(y.Redo),!0}clear(){this.setData([]),this.pushToUndo(),this.EventBusService.emit(y.Clear)}addElements(t){const i=this.getData(),s=Array.isArray(t)?t:[t];this.setData([...i,...s]),this.pushToUndo(),this.EventBusService.emit(y.ElementsAdded,s)}addToDraft(t){this.draftData.next([...this.draftData.getValue(),t])}updateDraft(t){const i=this.draftData.getValue(),s=i.findIndex(o=>o.id===t.id);s>-1&&(i[s]=t,this.draftData.next(i))}commitDraftToData(){const t=this.draftData.getValue();t.length&&(this.setData([...this.data.getValue(),...t]),this.pushToUndo(),this.draftData.next([]))}updateElements(t,i=!0){const s=Array.isArray(t)?t:[t],o=this.getData();s.forEach(a=>{const l=o.findIndex(h=>h.id===a.id);l>-1&&(o[l]={...o[l],...a})}),this.setData(o),i&&(this.pushToUndo(),this.EventBusService.emit(y.ElementsUpdated,s))}removeElements(t,i=!0){const s=Array.isArray(t)?t:[t],o=s.map(a=>"string"==typeof a?a:a.id);if(s.length){const a=this.getData();this.EventBusService.emit(y.ElementsDeleted);const l=a.filter(h=>!o.includes(h.id));i&&(this.setData(l),this.pushToUndo())}}hasElement(t){return this.getData().some(i=>i.id===t.id)}getActiveTool(){return this.selectedTool.getValue()}setActiveTool(t){this.selectedTool.next(t),this.EventBusService.emit(y.ToolChange,t)}selectElements(t,i=!1){const o=(Array.isArray(t)?t:[t]).map(h=>"string"==typeof h?h:h.id),a=Array.from(this.selectedElementIds.getValue()),l=i?[...new Set([...a,...o])]:o;this.selectedElementIds.next(new Set(l)),this.updateBoundingBox(),this.EventBusService.emit(y.ElementsSelected,l.map(h=>this.getElementById(h)))}toggleSelection(t){const i="string"==typeof t?t:t.id,s=new Set(this.selectedElementIds.getValue());s.has(i)?s.delete(i):s.add(i),this.selectedElementIds.next(s),this.updateBoundingBox()}deselectElement(t){const i="string"==typeof t?t:t.id,s=new Set(this.selectedElementIds.getValue());s.delete(i),this.selectedElementIds.next(s),this.updateBoundingBox()}clearSelection(){this.selectedElementIds.getValue().size>0&&(this.selectedElementIds.next(new Set),this.clearBoundingBox(),this.EventBusService.emit(y.ElementsSelected,[]))}selectAll(){const t=new Set(this.getData().map(i=>i.id));this.selectedElementIds.next(t),this.updateBoundingBox()}getSelectedIds(){return Array.from(this.selectedElementIds.getValue())}getSelectedElements(){const t=this.getSelectedIds();return this.getData().filter(i=>t.includes(i.id))}updateSelectedElements(t){const i=this.getSelectedElements();i.forEach(s=>{const o={...s,...t};this.updateElements(o,!1)}),this.updateBoundingBox(),this.EventBusService.emit(y.ElementsSelected,i),this.debouncedPushToUndo()}transformSelectedElements(t){const i=this.getSelectedElements(),s=t(i);this.updateElements(s,!1),this.updateBoundingBox(),this.EventBusService.emit(y.ElementsSelected,i),this.debouncedPushToUndo()}updateBoundingBox(){const t=this.getSelectedElements();if(0===t.length)return void this.clearBoundingBox();const i=t.map(je),s=Math.min(...i.map(S=>S.minX)),o=Math.min(...i.map(S=>S.minY)),a=Math.max(...i.map(S=>S.maxX)),l=Math.max(...i.map(S=>S.maxY)),h=a-s;let R=0;1===t.length&&(R=t[0].rotation||0),this.boundingBox.next({x:s,y:o,width:h,height:l-o,handles:{topLeft:{x:s,y:o},topRight:{x:a,y:o},bottomLeft:{x:s,y:l},bottomRight:{x:a,y:l},rotateHandle:{x:s+h/2,y:o-20}},rotation:R})}getBoundingBox(){return this.boundingBox.getValue()}clearBoundingBox(){this.boundingBox.next(null)}setSelectionBox(t){this.selectionBox.next(t)}getSelectionBox(){return this.selectionBox.getValue()}clearSelectionBox(){this.selectionBox.next({x:0,y:0,width:0,height:0,visible:!1})}setCanvasDimensions(t,i){this.configService.updateConfig({canvasWidth:t,canvasHeight:i})}setCanvasPosition(t,i){this.configService.updateConfig({x:t,y:i})}updateGridTranslation(t,i){this.configService.updateConfig({gridTranslation:{x:t,y:i}})}updateElementsTranslation(t,i){this.configService.updateConfig({elementsTranslation:{x:t,y:i}})}fullScreen(){this.setCanvasDimensions(this.svgContainer?.clientWidth||0,this.svgContainer?.clientHeight||0)}centerCanvas(){const{canvasWidth:t,canvasHeight:i,zoom:s}=this.getConfig();this.setCanvasPosition(((this.svgContainer?.clientWidth||0)-t*s)/2,((this.svgContainer?.clientHeight||0)-i*s)/2)}toggleGrid(){const{enableGrid:t}=this.getConfig();this.configService.updateConfig({enableGrid:!t})}addImage(t){const i=new Image;i.onload=()=>{const s=this.getConfig().canvasHeight,o=i.width,a=i.height,h=a>s?s-40:a,u=h===s-40?i.width/i.height*(s-40):o;let p=t.x||(o-u)*(t.x||0),v=t.y||(a-h)*(t.y||0);p<0&&(p=0),v<0&&(v=0);const R=st(d.R.Image,{src:t.image,width:u,height:h,x:p,y:v});this.addElements(R),this.selectElements(R),this.pushToUndo(),this.EventBusService.emit(y.ImageAdded,R.src)},i.src=t.image}save(t,i="New board"){var s=this;return(0,qt.A)(function*(){const a=s.getCanvas().getElementById("svgcontent").cloneNode(!0),l=a.querySelector("#selectorParentGroup");l&&l.remove();const h=a.querySelector("#contentBackground");h&&h.removeAttribute("opacity"),a.setAttribute("x","0"),a.setAttribute("y","0");const u=(new XMLSerializer).serializeToString(a),p=yield function Je(n,e,t,i=g.o8.Png){return new Promise((s,o)=>{const a=document.createElement("canvas");a.width=e,a.height=t;const l=a.getContext("2d"),h=new Image;h.src=`data:image/svg+xml;base64,${btoa(n)}`,h.onload=()=>{l.drawImage(h,0,0,e,t);const u=a.toDataURL(`image/${i}`);s(u)},h.onerror=u=>{o(u)}})}(u,s.getConfig().canvasWidth,s.getConfig().canvasHeight,t);switch(t){case g.o8.Base64:s.EventBusService.emit(y.Save,p);break;case g.o8.Svg:{const v="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(u)));he(v,i),s.EventBusService.emit(y.Save,v);break}default:he(p,i),s.EventBusService.emit(y.Save,p)}})()}static{this.\u0275fac=function(i){return new(i||n)(r.KVO(wt),r.KVO(It),r.KVO(r._9s))}}static{this.\u0275prov=r.jDH({token:n,factory:n.\u0275fac})}}return n})();var ce=f(5149);let de=(()=>{class n{constructor(t,i){this._dataService=t,this._whiteboardService=i,this.initializeActionListeners()}initializeActionListeners(){this._whiteboardService.actions$.pipe((0,Tt.p)(t=>t.length>0)).subscribe(t=>{t.forEach(i=>this.handleAction(i))})}handleAction(t){switch(t.type){case w.X.Undo:this._dataService.undo();break;case w.X.Redo:this._dataService.redo();break;case w.X.Clear:this._dataService.clear();break;case w.X.UpdateSelectedElements:this._dataService.updateSelectedElements(t.payload.partialElement);break;case w.X.Save:{const{format:i,name:s}=t.payload;this._dataService.save(i,s);break}case w.X.AddElement:this._dataService.addElements(t.payload.element);break;case w.X.UpdateElement:this._dataService.updateElements(t.payload.element);break;case w.X.RemoveElements:this._dataService.removeElements(t.payload.ids);break;case w.X.SelectElements:this._dataService.selectElements(t.payload.elementsOrIds);break;case w.X.SetActiveTool:this._dataService.setActiveTool(t.payload.tool);break;case w.X.ToggleSelection:this._dataService.toggleSelection(t.payload.elementOrId);break;case w.X.DeselectElement:this._dataService.deselectElement(t.payload.elementOrId);break;case w.X.SelectAll:this._dataService.selectAll();break;case w.X.ClearSelection:this._dataService.clearSelection();break;case w.X.ToggleGrid:this._dataService.toggleGrid();break;case w.X.AddImage:this._dataService.addImage(t.payload);break;case w.X.SetCanvasDimensions:{const{width:i,height:s}=t.payload;this._dataService.setCanvasDimensions(i,s);break}case w.X.SetCanvasPosition:{const{x:i,y:s}=t.payload;this._dataService.setCanvasPosition(i,s);break}case w.X.UpdateGridTranslation:{const{dx:i,dy:s}=t.payload;this._dataService.updateGridTranslation(i,s);break}case w.X.UpdateElementsTranslation:{const{dx:i,dy:s}=t.payload;this._dataService.updateElementsTranslation(i,s);break}case w.X.FullScreen:this._dataService.fullScreen();break;case w.X.CenterCanvas:this._dataService.centerCanvas();break;case w.X.Batch:t.payload.forEach(i=>this.handleAction(i))}}static{this.\u0275fac=function(i){return new(i||n)(r.KVO(Et),r.KVO(ce.K))}}static{this.\u0275prov=r.jDH({token:n,factory:n.\u0275fac})}}return n})();function ue(n,e,t,i){const s=Math.PI/4,o=t-n,a=i-e,l=Math.atan2(a,o),h=Math.sqrt(o*o+a*a),u=Math.round(l/s)*s;return{x:n+h*Math.cos(u),y:e+h*Math.sin(u),a:u}}function D(n,e){return Math.round(n/e)*e}class H{constructor(e){this.dataService=e,this.active=!1}get whiteboardConfig(){return this.dataService?.getConfig()}getPointerPosition(e){return function Qe(n,{x:e,y:t}){const{zoom:i,x:s,y:o,elementsTranslation:a}=n;return{x:(e-s)/i-a.x,y:(t-o)/i-a.y}}(this.dataService.getConfig(),{x:e.offsetX,y:e.offsetY})}activate(){this.active=!0,this.onActivate?.()}deactivate(){this.active=!1,this.onDeactivate?.()}get isActive(){return this.active}}class Ke extends H{constructor(){super(...arguments),this.type=M.p.Hand,this.isDragging=!1,this.startX=0,this.startY=0}handlePointerDown(e){this.isDragging=!0,this.startX=e.clientX,this.startY=e.clientY}handlePointerMove(e){if(!this.isDragging)return;const t=e.clientX-this.startX,i=e.clientY-this.startY,{gridTranslation:s,elementsTranslation:o}=this.dataService.getConfig(),l={x:o.x+t,y:o.y+i};this.updateGridPosition((s.x+t)%100,(s.y+i)%100),this.updateElementsPosition(l.x,l.y),this.startX=e.clientX,this.startY=e.clientY}handlePointerUp(){this.isDragging=!1}updateGridPosition(e,t){this.dataService.updateGridTranslation(e,t)}updateElementsPosition(e,t){this.dataService.updateElementsTranslation(e,t)}}class Ze extends H{constructor(){super(...arguments),this.type=M.p.Arrow,this.element=null,this.startPoint=null,this.lastX=0,this.lastY=0,this.MIN_LENGTH=2}handlePointerDown(e){if(!this.active)return;const t=this.getPointerPosition(e);let{x:i,y:s}=t;const{snapToGrid:o}=this.whiteboardConfig;if(o){const{gridSize:a}=this.whiteboardConfig;i=D(i,a),s=D(s,a)}this.startPoint={x:i,y:s},this.lastX=i,this.lastY=s,this.element=st(d.R.Arrow,{x1:i,y1:s,x2:i,y2:s,style:this.getElementStyle()}),this.dataService.addToDraft(this.element)}handlePointerMove(e){if(!this.active||!this.element)return;const t=this.getPointerPosition(e);let i=t.x,s=t.y;const{snapToGrid:o}=this.whiteboardConfig;if(o){const{gridSize:a}=this.whiteboardConfig;i=D(i,a),s=D(s,a)}if(e.shiftKey){const a=this.element.x1,l=this.element.y1,{x:h,y:u}=ue(a,l,i,s);i=h,s=u}(Math.abs(i-this.lastX)>this.MIN_LENGTH||Math.abs(s-this.lastY)>this.MIN_LENGTH)&&(this.element.x2=i,this.element.y2=s,this.lastX=i,this.lastY=s)}handlePointerUp(){this.active&&(this.element&&this.startPoint&&(this.dataService.commitDraftToData(),this.startPoint=null,this.element=null),this.lastX=0,this.lastY=0)}getElementStyle(){return{strokeColor:this.whiteboardConfig.strokeColor,strokeWidth:this.whiteboardConfig.strokeWidth,lineCap:this.whiteboardConfig.lineCap,dasharray:this.whiteboardConfig.dasharray,dashoffset:this.whiteboardConfig.dashoffset}}}class qe extends H{constructor(){super(...arguments),this.type=M.p.Ellipse,this.element=null,this.startPoint=null}handlePointerDown(e){if(!this.active)return;let{x:t,y:i}=this.getPointerPosition(e);const{snapToGrid:s}=this.whiteboardConfig;if(s){const{gridSize:o}=this.whiteboardConfig;t=D(t,o),i=D(i,o)}this.startPoint={x:t,y:i},this.element=st(d.R.Ellipse,{cx:t,cy:i,style:this.getElementStyle()}),this.dataService.addToDraft(this.element)}handlePointerMove(e){if(!this.active||!this.element||!this.startPoint)return;const{x:t,y:i}=this.getPointerPosition(e),s=this.startPoint.x,o=this.startPoint.y;let a=Math.abs(s+(t-s)/2),l=Math.abs(o+(i-o)/2),h=Math.abs(s-a),u=Math.abs(o-l);e.shiftKey&&(u=h,l=i>o?o+h:o-h),e.altKey&&(a=s,l=o,h=Math.abs(t-a),u=e.shiftKey?h:Math.abs(i-l)),this.element.rx=h,this.element.ry=u,this.element.cx=a,this.element.cy=l}handlePointerUp(){this.active&&this.element&&this.startPoint&&(this.dataService.commitDraftToData(),this.startPoint=null,this.element=null)}getElementStyle(){return{strokeColor:this.whiteboardConfig.strokeColor,strokeWidth:this.whiteboardConfig.strokeWidth,fill:this.whiteboardConfig.fill,dasharray:this.whiteboardConfig.dasharray,dashoffset:this.whiteboardConfig.dashoffset}}}class ti extends H{constructor(){super(...arguments),this.type=M.p.Eraser,this.isErasing=!1,this.hoveredElementIds=new Set,this.lastPosition=null}handlePointerDown(e){if(!this.active)return;this.hoveredElementIds.clear();const t=this.getPointerPosition(e);this.isErasing=!0,this.eraseElementsAt(t,t),this.lastPosition=t}handlePointerMove(e){if(!this.active||!this.isErasing||!this.lastPosition)return;const t=this.getPointerPosition(e);this.eraseElementsAt(this.lastPosition,t,e.altKey),this.lastPosition=t}handlePointerUp(){if(this.active){if(this.hoveredElementIds.size>0){const e=Array.from(this.hoveredElementIds);this.dataService.updateElements(e.map(t=>({id:t,isDeleting:!1})),!1),this.dataService.removeElements(e)}this.hoveredElementIds.clear(),this.isErasing=!1,this.lastPosition=null}}eraseElementsAt(e,t,i=!1){const s=this.dataService.getData(),o=this.dataService.getConfig()?.zoom||1,a=Math.hypot(t.x-e.x,t.y-e.y),u=10/o+a*(.5*Math.log2(a+1));for(const p of s)$e(Ct(p.type).getBounds(p),e,t,u)&&this.isPointInElement(p,e,t,u)&&(i&&(this.hoveredElementIds.delete(p.id),p.isDeleting=!1),!i&&!this.hoveredElementIds.has(p.id)&&(this.hoveredElementIds.add(p.id),p.isDeleting=!0),this.dataService.updateElements(p,!1))}isPointInElement(e,t,i,s){return Ct(e.type).hitTest(e,t,i,s)}}class ei extends H{constructor(){super(...arguments),this.type=M.p.Image}handlePointerDown(e){const{x:t,y:i}=this.getPointerPosition(e),s=document.createElement("input");s.type="file",s.accept="image/*",s.onchange=o=>{const a=o.target.files;if(a){const l=new FileReader;l.onload=h=>{this.dataService.addImage({image:h.target.result,x:t,y:i})},l.readAsDataURL(a[0])}},s.click()}}class ii extends H{constructor(){super(...arguments),this.type=M.p.Line,this.element=null,this.startPoint=null,this.lastX=0,this.lastY=0,this.MIN_LENGTH=2}handlePointerDown(e){if(!this.active)return;let{x:t,y:i}=this.getPointerPosition(e);const{snapToGrid:s}=this.whiteboardConfig;if(s){const{gridSize:o}=this.whiteboardConfig;t=D(t,o),i=D(i,o)}this.startPoint={x:t,y:i},this.lastX=t,this.lastY=i,this.element=st(d.R.Line,{x1:t,y1:i,x2:t,y2:i,style:this.getElementStyle()}),this.dataService.addToDraft(this.element)}handlePointerMove(e){if(!this.active||!this.element)return;const t=this.getPointerPosition(e);let i=t.x,s=t.y;const{snapToGrid:o}=this.whiteboardConfig;if(o){const{gridSize:a}=this.whiteboardConfig;i=D(i,a),s=D(s,a)}if(e.shiftKey){const a=this.element.x1,l=this.element.y1,{x:h,y:u}=ue(a,l,i,s);[i,s]=[h,u]}(Math.abs(i-this.lastX)>this.MIN_LENGTH||Math.abs(s-this.lastY)>this.MIN_LENGTH)&&(this.element.x2=i,this.element.y2=s,this.lastX=i,this.lastY=s)}handlePointerUp(){this.active&&(this.element&&this.startPoint&&(this.dataService.commitDraftToData(),this.startPoint=null,this.element=null),this.lastX=0,this.lastY=0)}getElementStyle(){return{strokeColor:this.whiteboardConfig.strokeColor,strokeWidth:this.whiteboardConfig.strokeWidth,lineCap:this.whiteboardConfig.lineCap,dasharray:this.whiteboardConfig.dasharray,dashoffset:this.whiteboardConfig.dashoffset}}}class ni extends H{constructor(){super(...arguments),this.type=M.p.Pen,this.element=null}handlePointerDown(e){if(!this.active)return;const t=this.getPointerPosition(e);this.element=st(d.R.Pen,{points:[[t.x,t.y]],path:Ft([[t.x,t.y]]),style:this.getElementStyle()}),this.dataService.addToDraft(this.element)}handlePointerMove(e){if(!this.active||!this.element)return;const{x:t,y:i}=this.getPointerPosition(e),s=this.element.points;s.push([t,i]),this.element.points=s,this.element.path=Ft(s)}handlePointerUp(){this.active&&this.element&&(this.dataService.commitDraftToData(),this.element=null)}getElementStyle(){return{strokeColor:this.whiteboardConfig.strokeColor,strokeWidth:this.whiteboardConfig.strokeWidth,lineCap:this.whiteboardConfig.lineCap,lineJoin:this.whiteboardConfig.lineJoin,dasharray:this.whiteboardConfig.dasharray,dashoffset:this.whiteboardConfig.dashoffset}}}class si extends H{constructor(){super(...arguments),this.type=M.p.Rectangle,this.element=null,this.startPoint=null}handlePointerDown(e){if(!this.active)return;let{x:t,y:i}=this.getPointerPosition(e);const{snapToGrid:s}=this.whiteboardConfig;if(s){const{gridSize:o}=this.whiteboardConfig;t=D(t,o),i=D(i,o)}this.startPoint={x:t,y:i},this.element=st(d.R.Rectangle,{x:t,y:i,style:this.getElementStyle()}),this.dataService.addToDraft(this.element)}handlePointerMove(e){if(!this.active||!this.element||!this.startPoint)return;const{x:t,y:i}=this.getPointerPosition(e),s=this.startPoint.x,o=this.startPoint.y;let a=Math.abs(t-s),l=Math.abs(i-o),h=null,u=null;e.shiftKey?(a=l=Math.max(a,l),h=s<t?s:s-a,u=o<i?o:o-l):(h=Math.min(s,t),u=Math.min(o,i)),e.altKey&&(a*=2,l*=2,h=s-a/2,u=o-l/2);const{snapToGrid:p}=this.whiteboardConfig;if(p){const{gridSize:v}=this.whiteboardConfig;a=D(a,v),l=D(l,v),h=D(h,v),u=D(u,v)}this.element.width=a,this.element.height=l,this.element.x=h,this.element.y=u}handlePointerUp(){this.active&&this.element&&this.startPoint&&(this.dataService.commitDraftToData(),this.startPoint=null,this.element=null)}getElementStyle(){return{strokeColor:this.whiteboardConfig.strokeColor,strokeWidth:this.whiteboardConfig.strokeWidth,lineJoin:this.whiteboardConfig.lineJoin,fill:this.whiteboardConfig.fill,dasharray:this.whiteboardConfig.dasharray,dashoffset:this.whiteboardConfig.dashoffset}}}function ge(n){if(!n?.target)return null;let e=n.target;for(;e;){if(e.id===c.wM)return null;if(e.id.includes(c.RZ)||e.id.includes(c.YO)||e.id.includes(c.i$))return e;if(!e.parentNode)break;e=e.parentNode}return null}var N=function(n){return n[n.None=0]="None",n[n.Select=1]="Select",n[n.Move=2]="Move",n[n.Resize=3]="Resize",n[n.Rotate=4]="Rotate",n[n.BoxSelect=5]="BoxSelect",n}(N||{});class oi extends H{constructor(){super(...arguments),this.type=M.p.Select,this.currentAction=N.None,this.startPoint=null,this.currentHandle=null,this.rotateStartAngle=null,this.rotateStartTransform=null,this.selectionCenter=null,this.SNAP_THRESHOLD=5,this.ROTATION_SNAP_ANGLES=[0,45,90,135,180,225,270,315]}getCurrentAction(){return this.currentAction}getStartPoint(){return this.startPoint}getCurrentHandle(){return this.currentHandle}handlePointerDown(e){const t=ge(e),i=t?.id??"";if(this.startPoint=this.getPointerPosition(e),i.includes(c.RZ)){const s=t?.getAttribute(c.Bn)??null;this.handleElementSelect(s,e.shiftKey),this.currentAction=N.Move}else i.includes(c.Sb)?(this.currentHandle=this.getResizeDirection(i),this.currentAction=N.Resize):i.includes(c.Be)?(this.initializeRotation(e),this.currentAction=N.Rotate):i.includes(c.i$)?this.currentAction=N.Move:(this.initializeBoxSelect(e),this.currentAction=N.BoxSelect)}handlePointerMove(e){if(!this.startPoint)return;const t=this.getPointerPosition(e);switch(this.currentAction){case N.Move:this.handleMove(t,e.shiftKey);break;case N.Resize:this.handleResize(t,e.shiftKey);break;case N.Rotate:this.handleRotate(t,e.shiftKey);break;case N.BoxSelect:this.handleBoxSelect(t,e.shiftKey)}}handlePointerUp(){this.currentAction===N.BoxSelect&&this.dataService.clearSelectionBox(),this.currentAction=N.None,this.startPoint=null,this.currentHandle=null,this.rotateStartAngle=null,this.rotateStartTransform=null,this.selectionCenter=null}handleElementSelect(e,t){if(!e)return;const i=this.dataService.getElementById(e);i&&(t?this.dataService.toggleSelection(i):this.dataService.selectElements([i]))}handleMove(e,t){if(!this.startPoint)return;const i=e.x-this.startPoint.x,s=e.y-this.startPoint.y;let o=i,a=s;if(t){const l=nt(i,s);o=l.x,a=l.y}this.dataService.transformSelectedElements(l=>l.map(h=>({...h,x:h.x+o,y:h.y+a}))),this.startPoint=e}handleResize(e,t){if(!this.startPoint||null===this.currentHandle)return;const i=this.currentHandle;if(!this.dataService.getSelectedElements().length)return;const o=e.x-this.startPoint.x,a=e.y-this.startPoint.y;let l=o,h=a;if(t){const u=nt(o,a);l=u.x,h=u.y}this.dataService.transformSelectedElements(u=>u.map(p=>Ct(p.type).resize(p,i,l,h))),this.startPoint=e}handleRotate(e,t){if(!this.startPoint||!this.selectionCenter||null===this.rotateStartAngle)return;const i=pt(this.selectionCenter,e),s=this.dataService.getSelectedElements();if(0===s.length)return;let o=i-this.rotateStartAngle;o>180&&(o-=360),o<-180&&(o+=360);let l=(s[0].rotation||0)+o;t&&(l=function yt(n,e,t){const i=dt(n),s=e.reduce((a,l)=>Math.abs(i-l)<Math.abs(i-a)?l:a,e[0]);return Math.abs(i-s)<=t?s:n}(l,this.ROTATION_SNAP_ANGLES,this.SNAP_THRESHOLD)),this.dataService.transformSelectedElements(h=>h.map(u=>({...u,rotation:dt(l)}))),this.rotateStartAngle=i}handleBoxSelect(e,t){if(!this.startPoint)return;const i={x:Math.min(this.startPoint.x,e.x),y:Math.min(this.startPoint.y,e.y),width:Math.abs(e.x-this.startPoint.x),height:Math.abs(e.y-this.startPoint.y),visible:!0};this.dataService.setSelectionBox(i);const o=this.dataService.getData().filter(a=>this.checkElementInSelectionBox(a,i));this.dataService.selectElements(o,t),this.dataService.updateBoundingBox()}initializeBoxSelect(e){e.shiftKey||this.dataService.clearSelection();const{x:t,y:i}=this.getPointerPosition(e);this.dataService.setSelectionBox({x:t,y:i,width:0,height:0,visible:!0})}initializeRotation(e){const t=this.dataService.getBoundingBox();if(!t)return;this.selectionCenter={x:t.x+t.width/2,y:t.y+t.height/2};const i=this.getPointerPosition(e);this.rotateStartAngle=pt(this.selectionCenter,i)}checkElementInSelectionBox(e,t){return function L(n,e){return n.minX<=e.x+e.width&&n.maxX>=e.x&&n.minY<=e.y+e.height&&n.maxY>=e.y}(Ct(e.type).getBounds(e),t)}getResizeDirection(e){const t=e.split("_")[2];let i;if(!Object.values(g.OP).includes(t))return g.OP.N;i=t;const s=this.dataService.getSelectedElements();return 0===s.length?i:function Rt(n,e){const t=Math.round(dt(e)/45)%8,i=Object.values(g.OP),o=(i.indexOf(n)+t)%8;return i[o]}(i,s[0].rotation||0)}onActivate(){this.dataService.clearSelection()}onDeactivate(){this.dataService.clearSelection()}}class ai extends H{constructor(){super(...arguments),this.type=M.p.Text,this.textElement=null,this.textInput=null}handlePointerDown(e){if(!this.active)return;if(this.textInput)return void this.finishTextInput();const t=function ri(n,e){const t=ge(n);if(t){if(t.id===c.Mt)return null;const i=t.getAttribute(c.Bn);return e.find(o=>o.id===i)||null}return null}(e,this.dataService.getData());if(t&&t.type===d.R.Text)return this.textElement=t,void this.createTextInput(t.x,t.y,t.text);const{x:i,y:s}=this.getPointerPosition(e);this.textElement=this.createTextElement(i,s),this.createTextInput(i,s)}handlePointerUp(){this.textInput&&(this.textInput.addEventListener("blur",()=>this.finishTextInput()),this.textInput.focus())}createTextElement(e,t){const{snapToGrid:i,gridSize:s}=this.whiteboardConfig;return st(d.R.Text,{x:i?D(e,s):e,y:i?D(t,s):t,text:"",style:this.getElementStyle()})}createTextInput(e,t,i=""){const{zoom:s,elementsTranslation:o}=this.whiteboardConfig,a=this.dataService.getCanvas().parentElement?.querySelector("#textInput");a.value=i,a.style.left=(e-Math.abs(o.x))*s+"px",a.style.top=(t-Math.abs(o.y))*s+"px",a.style.fontFamily=this.textElement?.style.fontFamily||this.whiteboardConfig.fontFamily,a.style.fontSize=`${this.textElement?.style.fontSize||this.whiteboardConfig.fontSize}px`,a.style.color=this.textElement?.style.color||this.whiteboardConfig.strokeColor,a.style.transform=`scale(${this.textElement?.scaleX||1}, ${this.textElement?.scaleY||1})`,a.style.display="block",a.addEventListener("input",()=>this.handleTextInput(a)),a.addEventListener("keydown",l=>{"Enter"===l.key&&this.finishTextInput()}),this.textInput=a}handleTextInput(e){e.style.width=`${e.value.length}ch`,this.textElement&&(this.textElement.text=e.value,this.dataService.updateElements(this.textElement))}finishTextInput(){this.textInput&&this.textElement&&(this.textInput.value.trim()?this.dataService.hasElement(this.textElement)||(this.dataService.addElements(this.textElement),this.dataService.pushToUndo()):this.dataService.removeElements([this.textElement.id]),this.textInput.style.display="none",this.textInput=null,this.textElement=null)}getElementStyle(){return{color:this.whiteboardConfig.strokeColor,fontSize:this.whiteboardConfig.fontSize,fontFamily:this.whiteboardConfig.fontFamily,lineJoin:this.whiteboardConfig.lineJoin,lineCap:this.whiteboardConfig.lineCap,dasharray:this.whiteboardConfig.dasharray,dashoffset:this.whiteboardConfig.dashoffset,strokeColor:this.whiteboardConfig.fill,strokeWidth:0}}}let fe=(()=>{class n{constructor(t){this.dataService=t,this.toolRegistry=new Map,this.initializeDefaultTools(t),this.dataService.selectedTool$.pipe(x()).subscribe(i=>{this.setCurrentTool(i)})}registerTool(t,i){if(this.toolRegistry.has(t))throw new Error(`Tool of type '${t}' is already registered.`);this.toolRegistry.set(t,i)}initializeDefaultTools(t){this.registerTool(M.p.Hand,new Ke(t)),this.registerTool(M.p.Pen,new ni(t)),this.registerTool(M.p.Line,new ii(t)),this.registerTool(M.p.Arrow,new Ze(t)),this.registerTool(M.p.Rectangle,new si(t)),this.registerTool(M.p.Ellipse,new qe(t)),this.registerTool(M.p.Text,new ai(t)),this.registerTool(M.p.Image,new ei(t)),this.registerTool(M.p.Select,new oi(t)),this.registerTool(M.p.Eraser,new ti(t))}setCurrentTool(t){const i=this.currentTool,s=this.toolRegistry.get(t);if(i&&i.deactivate(),!s)throw new Error(`Tool of type '${t}' not found.`);s.activate(),this.currentTool=s}getCurrentTool(){const t=this.currentTool;if(!t)throw new Error("No active tool found.");return t}getCurrentToolType(){return this.currentTool.type}getTool(t){const i=this.toolRegistry.get(t);if(!i)throw new Error(`Tool of type '${t}' not found.`);return i}clearRegistry(){this.toolRegistry.clear()}static{this.\u0275fac=function(i){return new(i||n)(r.KVO(Et))}}static{this.\u0275prov=r.jDH({token:n,factory:n.\u0275fac})}}return n})(),me=(()=>{class n{constructor(t,i,s){this.toolManager=t,this.configService=i,this.EventBusService=s,this.pointerDownSubject=new Ot.B,this.pointerMoveSubject=new Ot.B,this.pointerUpSubject=new Ot.B}onPointerDown(t){if(!this.canDraw())return;this.EventBusService.emit(y.DrawStart,t);const i=this.toolManager.getCurrentTool();i&&i.handlePointerDown&&i.handlePointerDown(t),this.pointerDownSubject.next(t)}onPointerMove(t){if(!this.canDraw())return;this.EventBusService.emit(y.Drawing,t);const i=this.toolManager.getCurrentTool();i&&i.handlePointerMove&&i.handlePointerMove(t),this.pointerMoveSubject.next(t)}onPointerUp(t){if(!this.canDraw())return;this.EventBusService.emit(y.DrawEnd);const i=this.toolManager.getCurrentTool();i&&i.handlePointerUp&&i.handlePointerUp(t),this.pointerUpSubject.next(t)}getPointerDown$(){return this.pointerDownSubject.asObservable()}getPointerMove$(){return this.pointerMoveSubject.asObservable()}getPointerUp$(){return this.pointerUpSubject.asObservable()}canDraw(){return this.configService.getConfig().drawingEnabled}static{this.\u0275fac=function(i){return new(i||n)(r.KVO(fe),r.KVO(It),r.KVO(wt))}}static{this.\u0275prov=r.jDH({token:n,factory:n.\u0275fac})}}return n})();const pe="nw-resize",ye="ne-resize",ve="ns-resize",xe="ew-resize";let gi=(()=>{class n{constructor(){this.cornerGrips=["nw","ne","se","sw"],this.sideGrips=["n","s","e","w"]}transform(t,i){if(t.includes("rotate"))return"grab";const s=this.isHorizontalOrientation(i);return this.cornerGrips.includes(t)?this.getCornerCursor(t,s):this.sideGrips.includes(t)?this.getSideCursor(t,s):"default"}isHorizontalOrientation(t){const i=t%180;return i<45||i>135}getCornerCursor(t,i){return"nw"===t||"se"===t?i?pe:ye:i?ye:pe}getSideCursor(t,i){return"n"===t||"s"===t?i?ve:xe:i?xe:ve}static{this.\u0275fac=function(i){return new(i||n)}}static{this.\u0275pipe=r.EJ8({name:"gripCursor",type:n,pure:!0,standalone:!0})}}return n})(),fi=(()=>{class n{constructor(t){this.svgService=t}onPointerDown(t){0===t.button&&(t.currentTarget&&t.currentTarget.setPointerCapture(t.pointerId),this.svgService.onPointerDown(t))}onPointerMove(t){t.clientX===this.lastX&&t.clientY===this.lastY||(this.lastX=t.clientX,this.lastY=t.clientY,this.svgService.onPointerMove(t))}onPointerUp(t){0===t.button&&(this.lastX=t.clientX,this.lastY=t.clientY,t.currentTarget&&t.currentTarget.hasPointerCapture(t.pointerId)&&t.currentTarget.releasePointerCapture(t.pointerId),this.svgService.onPointerUp(t))}static{this.\u0275fac=function(i){return new(i||n)(r.rXU(me))}}static{this.\u0275dir=r.FsC({type:n,selectors:[["","svg",""]],hostBindings:function(i,s){1&i&&r.bIt("pointerdown",function(a){return s.onPointerDown(a)})("pointermove",function(a){return s.onPointerMove(a)})("pointerup",function(a){return s.onPointerUp(a)})},standalone:!0})}}return n})(),mi=(()=>{class n{constructor(t,i,s){this.elementRef=t,this.dataService=i,this._cd=s}ngOnInit(){this.resizeObserver=new ResizeObserver(([t])=>{if(t.target===this.elementRef.nativeElement){const{fullScreen:i,center:s}=this.dataService.getConfig();i&&this.dataService.fullScreen(),s&&!i&&this.dataService.centerCanvas(),this._cd.detectChanges()}}),this.resizeObserver.observe(this.elementRef.nativeElement)}ngOnDestroy(){this.resizeObserver?.disconnect()}static{this.\u0275fac=function(i){return new(i||n)(r.rXU(r.aKT),r.rXU(Et),r.rXU(r.gRc))}}static{this.\u0275dir=r.FsC({type:n,selectors:[["","resizeHandler",""]],standalone:!0})}}return n})();const pi=["svgContainer"],yi=(n,e)=>e.id,vi=(n,e)=>[0,0,n,e],xi=()=>["n","s","e","w"],Se=()=>["nw","ne","se","sw"];function Si(n,e){if(1&n&&(r.qSk(),r.j41(0,"g"),r.nrm(1,"rect",17),r.k0s()),2&n){const t=r.XpG();r.BMQ("transform","translate("+t.gridTranslation.x+","+t.gridTranslation.y+")"),r.R7$(),r.BMQ("width",t.canvasWidth+200)("height",t.canvasHeight+200)}}function Ci(n,e){if(1&n&&(r.qSk(),r.j41(0,"g"),r.nrm(1,"path",18),r.k0s()),2&n){const t=r.XpG().$implicit;r.R7$(),r.BMQ("d",t.path)("stroke-width",t.style.strokeWidth)("stroke-linecap",t.style.lineCap)("stroke-linejoin",t.style.lineJoin)("stroke",t.style.strokeColor)("stroke-dasharray",t.style.dasharray)("stroke-dashoffset",t.style.dashoffset)}}function wi(n,e){if(1&n&&(r.qSk(),r.j41(0,"g"),r.nrm(1,"image",19),r.k0s()),2&n){const t=r.XpG().$implicit;r.R7$(),r.BMQ("height",t.height)("width",t.width)("href",t.src,null,"xlink")("href",t.src)("stroke-width",t.style.strokeWidth)("fill",t.style.fill)("stroke",t.style.strokeColor)("stroke-dasharray",t.style.dasharray)("stroke-dashoffset",t.style.dashoffset)}}function Ei(n,e){if(1&n&&(r.qSk(),r.j41(0,"g"),r.nrm(1,"line"),r.k0s()),2&n){const t=r.XpG().$implicit;r.R7$(),r.BMQ("x1",t.x1)("y1",t.y1)("x2",t.x2)("y2",t.y2)("stroke-dasharray",t.style.dasharray)("stroke-dashoffset",t.style.dashoffset)("stroke-width",t.style.strokeWidth)("stroke-linecap",t.style.lineCap)("stroke",t.style.strokeColor)}}function bi(n,e){if(1&n&&(r.qSk(),r.j41(0,"g"),r.nrm(1,"line",20),r.k0s()),2&n){const t=r.XpG().$implicit;r.R7$(),r.BMQ("x1",t.x1)("y1",t.y1)("x2",t.x2)("y2",t.y2)("stroke-dasharray",t.style.dasharray)("stroke-dashoffset",t.style.dashoffset)("stroke-width",t.style.strokeWidth)("stroke-linecap",t.style.lineCap)("stroke",t.style.strokeColor)("fill",t.style.strokeColor)}}function Pi(n,e){if(1&n&&(r.qSk(),r.j41(0,"g"),r.nrm(1,"rect"),r.k0s()),2&n){const t=r.XpG().$implicit;r.R7$(),r.BMQ("rx",t.rx)("width",t.width)("height",t.height)("stroke-dasharray",t.style.dasharray)("stroke-dashoffset",t.style.dashoffset)("stroke-width",t.style.strokeWidth)("fill",t.style.fill)("stroke",t.style.strokeColor)("stroke-linejoin",t.style.lineJoin)}}function Mi(n,e){if(1&n&&(r.qSk(),r.j41(0,"g"),r.nrm(1,"ellipse"),r.k0s()),2&n){const t=r.XpG().$implicit;r.R7$(),r.BMQ("cx",t.cx)("cy",t.cy)("rx",t.rx)("ry",t.ry)("stroke-dasharray",t.style.dasharray)("stroke-dashoffset",t.style.dashoffset)("stroke-width",t.style.strokeWidth)("stroke",t.style.strokeColor)("fill",t.style.fill)}}function ki(n,e){if(1&n&&(r.qSk(),r.j41(0,"g")(1,"text",21),r.EFF(2),r.k0s()()),2&n){const t=r.XpG().$implicit;r.BMQ("transform","scale("+t.scaleX+","+t.scaleY+")"),r.R7$(),r.BMQ("font-size",t.style.fontSize)("font-family",t.style.fontFamily)("fill",t.style.color)("font-style",t.style.fontStyle)("font-weight",t.style.fontWeight)("stroke-linecap",t.style.lineCap)("stroke-lineJoin",t.style.lineJoin)("stroke-dasharray",t.style.dasharray)("stroke-dashoffset",t.style.dashoffset)("stroke",t.style.strokeColor)("stroke-width",t.style.strokeWidth),r.R7$(),r.SpI(" ",t.text," ")}}function Ti(n,e){if(1&n&&(r.qSk(),r.j41(0,"g",13),r.DNE(1,Ci,2,7)(2,wi,2,9)(3,Ei,2,9)(4,bi,2,10)(5,Pi,2,9)(6,Mi,2,9)(7,ki,3,13),r.k0s()),2&n){let t;const i=e.$implicit,s=r.XpG();r.Y8G("id","item_"+i.id),r.BMQ("data-wb-id",i.id)("transform","translate("+i.x+","+i.y+")rotate("+i.rotation+")")("opacity",i.isDeleting?.1:i.opacity/100),r.R7$(),r.vxM(1,(t=i.type)===s.types.Pen?1:t===s.types.Image?2:t===s.types.Line?3:t===s.types.Arrow?4:t===s.types.Rectangle?5:t===s.types.Ellipse?6:t===s.types.Text?7:-1)}}function Bi(n,e){if(1&n&&(r.qSk(),r.nrm(0,"rect",14)),2&n){const t=e;r.BMQ("x",t.x)("y",t.y)("width",t.width)("height",t.height)}}function Di(n,e){if(1&n&&(r.qSk(),r.qex(0),r.nrm(1,"rect",25),r.nI1(2,"gripCursor"),r.bVm()),2&n){const t=e.$implicit,i=r.XpG();r.R7$(),r.BMQ("id","selectorGrip_resize_"+t)("x","n"===t||"s"===t?i.x:"e"===t?i.x+i.width-5:i.x-5)("y","n"===t?i.y-5:"s"===t?i.y+i.height-5:i.y)("width","n"===t||"s"===t?i.width:10)("height","n"===t||"s"===t?10:i.height)("cursor",r.i5U(2,6,t,i.rotation))}}function Ri(n,e){if(1&n&&(r.qSk(),r.qex(0),r.nrm(1,"rect",26),r.nI1(2,"gripCursor"),r.bVm()),2&n){const t=e.$implicit,i=r.XpG();r.R7$(),r.BMQ("id","selectorGrip_resize_"+t)("x",i.x+("ne"===t||"se"===t?i.width:0)-5)("y",i.y+("se"===t||"sw"===t?i.height:0)-5)("cursor",r.i5U(2,4,t,i.rotation))}}function Oi(n,e){if(1&n&&(r.qSk(),r.qex(0),r.nrm(1,"circle",27),r.nI1(2,"gripCursor"),r.bVm()),2&n){const t=e.$implicit,i=r.XpG();r.R7$(),r.BMQ("id","selectorGrip_rotate_"+t)("cx",i.x+("ne"===t||"se"===t?i.width:-20)+10)("cy",i.y+("se"===t||"sw"===t?i.height:-20)+10)("cursor",r.i5U(2,4,"rotate_"+t,i.rotation))}}function Ii(n,e){if(1&n&&(r.qSk(),r.j41(0,"g",15),r.nrm(1,"rect",22),r.DNE(2,Di,3,9,"ng-container",23)(3,Ri,3,7,"ng-container",23),r.nrm(4,"circle",24),r.DNE(5,Oi,3,7,"ng-container",23),r.k0s()),2&n){const t=e;r.BMQ("transform","rotate("+t.rotation+","+(t.x+t.width/2)+","+(t.y+t.height/2)+")"),r.R7$(),r.BMQ("x",t.x)("y",t.y)("width",t.width)("height",t.height),r.R7$(),r.Y8G("ngForOf",r.lJ4(10,xi)),r.R7$(),r.Y8G("ngForOf",r.lJ4(11,Se)),r.R7$(),r.BMQ("cx",t.handles.rotateHandle.x)("cy",t.handles.rotateHandle.y),r.R7$(),r.Y8G("ngForOf",r.lJ4(12,Se))}}function Xi(n,e){if(1&n&&(r.j41(0,"div",28),r.nrm(1,"input",29,1),r.k0s()),2&n){const t=r.sdS(2),i=r.XpG();r.xc7("font-family",i.fontFamily)("font-size",i.fontSize,"px")("pointer-events","none")("width",i.canvasWidth*i.zoom,"px")("height",i.canvasHeight*i.zoom,"px")("position","absolute")("top",i.y,"px")("left",i.x,"px"),r.R7$(),r.xc7("width",t.value.length+"ch")("height",2*i.zoom+"ch")}}let _i=(()=>{class n{set data(t){t&&t!==this.dataService.getData()&&this.dataService.setData(t)}get data$(){return this.dataService.getData$()}set selectedTool(t){t&&this.dataService.getActiveTool()!==t&&this.dataService.setActiveTool(t)}get selectedTool(){return this.dataService.getActiveTool()}set drawingEnabled(t){this.setConfigValue("drawingEnabled",t)}set canvasWidth(t){this.setConfigValue("canvasWidth",t)}get canvasWidth(){return this.getConfigValue("canvasWidth")}set canvasHeight(t){this.setConfigValue("canvasHeight",t)}get canvasHeight(){return this.getConfigValue("canvasHeight")}set fullScreen(t){this.setConfigValue("fullScreen",t)}get fullScreen(){return this.getConfigValue("fullScreen")}set center(t){this.setConfigValue("center",t)}get center(){return this.getConfigValue("center")}set strokeColor(t){this.setConfigValue("strokeColor",t)}set strokeWidth(t){this.setConfigValue("strokeWidth",t)}set backgroundColor(t){this.setConfigValue("backgroundColor",t)}get backgroundColor(){return this.getConfigValue("backgroundColor")}set lineJoin(t){this.setConfigValue("lineJoin",t)}set lineCap(t){this.setConfigValue("lineCap",t)}set fill(t){this.setConfigValue("fill",t)}set zoom(t){this.setConfigValue("zoom",t)}get zoom(){return this.getConfigValue("zoom")}set fontFamily(t){this.setConfigValue("fontFamily",t)}get fontFamily(){return this.getConfigValue("fontFamily")}set fontSize(t){this.setConfigValue("fontSize",t)}get fontSize(){return this.getConfigValue("fontSize")}set dasharray(t){this.setConfigValue("dasharray",t)}set dashoffset(t){this.setConfigValue("dashoffset",t)}set x(t){this.setConfigValue("x",t)}get x(){return this.getConfigValue("x")}set y(t){this.setConfigValue("y",t)}get y(){return this.getConfigValue("y")}set enableGrid(t){this.setConfigValue("enableGrid",t)}get enableGrid(){return this.getConfigValue("enableGrid")}set gridSize(t){this.setConfigValue("gridSize",t)}get gridSize(){return this.getConfigValue("gridSize")}set snapToGrid(t){this.setConfigValue("snapToGrid",t)}constructor(t,i,s,o,a,l){this.whiteboardService=t,this.actionHandler=i,this.configService=s,this.dataService=o,this.eventBusService=a,this.cd=l,this.ready=new r.bkB,this.destroyed=new r.bkB,this.drawStart=new r.bkB,this.drawing=new r.bkB,this.drawEnd=new r.bkB,this.elementsAdded=new r.bkB,this.elementsUpdated=new r.bkB,this.elementsSelected=new r.bkB,this.elementsDeleted=new r.bkB,this.undo=new r.bkB,this.redo=new r.bkB,this.clear=new r.bkB,this.dataChange=new r.bkB,this.save=new r.bkB,this.imageAdded=new r.bkB,this.selectedToolChange=new r.bkB,this.configChanged=new r.bkB,this.types=d.R,this.tools=M.p,this.eventsMap={[y.Ready]:this.ready,[y.Destroyed]:this.destroyed,[y.DrawStart]:this.drawStart,[y.Drawing]:this.drawing,[y.DrawEnd]:this.drawEnd,[y.ElementsAdded]:this.elementsAdded,[y.ElementsUpdated]:this.elementsUpdated,[y.ElementsSelected]:this.elementsSelected,[y.ElementsDeleted]:this.elementsDeleted,[y.Undo]:this.undo,[y.Redo]:this.redo,[y.Clear]:this.clear,[y.DataChange]:this.dataChange,[y.Save]:this.save,[y.ImageAdded]:this.imageAdded,[y.ToolChange]:this.selectedToolChange,[y.ConfigChange]:this.configChanged},this.initObservables()}ngOnInit(){this.options&&this.populateInputsFromOptions(this.options)}ngOnChanges(t){t.options&&t.options.currentValue&&this.populateInputsFromOptions(t.options.currentValue)}ngAfterViewInit(){this.dataService.initializeWhiteboard(this.svgContainer.nativeElement)}ngOnDestroy(){this.eventBusService.emit(y.Destroyed)}get gridTranslation(){return this.getConfigValue("gridTranslation")}get elementsTranslation(){return this.getConfigValue("elementsTranslation")}get selectionBox$(){return this.dataService.selectionBox$}get boundingBox$(){return this.dataService.boundingBox$}getConfigValue(t){return this.configService.getConfig()[t]}setConfigValue(t,i){this.configService.isConfigDifferent(t,i)&&(this.configService.updateConfigValue(t,i),["canvasWidth","canvasHeight","zoom"].includes(t)&&this.center&&!this.fullScreen&&this.dataService.centerCanvas())}populateInputsFromOptions(t){t&&Object.entries(t).forEach(([i,s])=>{void 0!==s&&this.setConfigValue(i,s)})}initObservables(){this.eventBusService.listen().pipe(x(),(0,it.M)(()=>this.cd.markForCheck())).subscribe({next:t=>{t.payload?this.eventsMap[t.type].emit(t.payload):this.eventsMap[t.type].emit()},error:t=>console.error("Error occurred while listening to events:",t)})}static{this.\u0275fac=function(i){return new(i||n)(r.rXU(ce.K),r.rXU(de),r.rXU(It),r.rXU(Et),r.rXU(wt),r.rXU(r.gRc))}}static{this.\u0275cmp=r.VBU({type:n,selectors:[["ng-whiteboard"]],viewQuery:function(i,s){if(1&i&&r.GBs(pi,5),2&i){let o;r.mGM(o=r.lsd())&&(s.svgContainer=o.first)}},inputs:{options:"options",data:"data",selectedTool:"selectedTool",drawingEnabled:"drawingEnabled",canvasWidth:"canvasWidth",canvasHeight:"canvasHeight",fullScreen:"fullScreen",center:"center",strokeColor:"strokeColor",strokeWidth:"strokeWidth",backgroundColor:"backgroundColor",lineJoin:"lineJoin",lineCap:"lineCap",fill:"fill",zoom:"zoom",fontFamily:"fontFamily",fontSize:"fontSize",dasharray:"dasharray",dashoffset:"dashoffset",x:"x",y:"y",enableGrid:"enableGrid",gridSize:"gridSize",snapToGrid:"snapToGrid"},outputs:{ready:"ready",destroyed:"destroyed",drawStart:"drawStart",drawing:"drawing",drawEnd:"drawEnd",elementsAdded:"elementsAdded",elementsUpdated:"elementsUpdated",elementsSelected:"elementsSelected",elementsDeleted:"elementsDeleted",undo:"undo",redo:"redo",clear:"clear",dataChange:"dataChange",save:"save",imageAdded:"imageAdded",selectedToolChange:"selectedToolChange",configChanged:"configChanged"},standalone:!0,features:[r.Jv_([me,Et,fe,wt,It,de]),r.OA$,r.aNF],decls:22,vars:25,consts:[["svgContainer",""],["textInput",""],["id","svgroot","xlinkns","http://www.w3.org/2000/svg","svg","","resizeHandler",""],["id","svgcontent","xlinkns","http://www.w3.org/2000/svg"],["id","smallGrid","patternUnits","userSpaceOnUse"],["fill","none","stroke","gray","stroke-width","0.5"],["id","grid","width","100","height","100","patternUnits","userSpaceOnUse"],["width","100","height","100","fill","url(#smallGrid)"],["d","M 100 0 H 0 V 100","fill","none","stroke","gray","stroke-width","2"],["id","arrow","refX","3","refY","3","markerWidth","6","markerHeight","6","stroke","context-stroke","fill","none","orient","auto"],["d","M 0 0 L 3 3 L 0 6"],["width","100%","height","100%"],[2,"pointer-events","all"],["transform-origin","center",1,"wb_element",3,"id"],["stroke","blue","stroke-dasharray","5,5","fill","transparent"],["id","selectorParentGroup"],["id","text-editor",3,"font-family","font-size","pointer-events","width","height","position","top","left"],["id","grid","x","-100","y","-100","fill","url(#grid)"],["fill","none"],["preserveAspectRatio","none"],["marker-end","url(#arrow)"],["text-anchor","start","alignment-baseline","before-edge"],["id","selectorBox","fill","transparent","stroke","dodgerblue","stroke-width","1","cursor","move","pointer-events","all"],[4,"ngFor","ngForOf"],["id","selectorGrip_rotate_n","r","6","fill","white","stroke","green","stroke-width","1","cursor","grab"],["fill","transparent","stroke","transparent","pointer-events","all"],["width","10","height","10","fill","white","stroke","dodgerblue","stroke-width","1"],["r","6","fill","none","stroke","none","stroke-width","1"],["id","text-editor"],["type","text","id","textInput","autocomplete","off",1,"text-input"]],template:function(i,s){if(1&i&&(r.qSk(),r.j41(0,"svg",2,0)(2,"svg",3)(3,"defs")(4,"pattern",4),r.nrm(5,"path",5),r.k0s(),r.j41(6,"pattern",6),r.nrm(7,"rect",7)(8,"path",8),r.k0s(),r.j41(9,"marker",9),r.nrm(10,"path",10),r.k0s()(),r.nrm(11,"rect",11),r.DNE(12,Si,2,3,":svg:g"),r.j41(13,"g",12),r.Z7z(14,Ti,8,5,":svg:g",13,yi),r.nI1(16,"async"),r.DNE(17,Bi,1,4,":svg:rect",14),r.nI1(18,"async"),r.DNE(19,Ii,6,13,":svg:g",15),r.nI1(20,"async"),r.k0s()()(),r.DNE(21,Xi,3,20,"div",16)),2&i){let o,a;r.HbH("svgroot "+s.selectedTool),r.R7$(2),r.BMQ("width",s.canvasWidth*s.zoom)("height",s.canvasHeight*s.zoom)("viewBox",r.l_i(22,vi,s.canvasWidth,s.canvasHeight))("x",s.x)("y",s.y),r.R7$(2),r.BMQ("width",s.gridSize)("height",s.gridSize),r.R7$(),r.BMQ("d","M "+s.gridSize+" 0 H 0 V "+s.gridSize),r.R7$(6),r.BMQ("fill",s.backgroundColor),r.R7$(),r.vxM(12,s.enableGrid?12:-1),r.R7$(),r.BMQ("transform","translate("+s.elementsTranslation.x+","+s.elementsTranslation.y+")"),r.R7$(),r.Dyx(r.bMT(16,16,s.data$)),r.R7$(3),r.vxM(17,(o=r.bMT(18,18,s.selectionBox$))?17:-1,o),r.R7$(2),r.vxM(19,(a=r.bMT(20,20,s.boundingBox$))?19:-1,a),r.R7$(2),r.vxM(21,s.selectedTool===s.tools.Text?21:-1)}},dependencies:[O.MD,O.Sq,O.Jj,gi,fi,mi],styles:["[_nghost-%COMP%]{width:inherit;height:inherit;min-width:inherit;min-height:inherit;max-width:inherit;max-height:inherit}[_nghost-%COMP%]   .svgroot[_ngcontent-%COMP%]{-webkit-user-select:none;user-select:none;width:inherit;height:inherit;min-width:inherit;min-height:inherit;max-width:inherit;max-height:inherit;background-size:cover;background-position:50%;background-repeat:no-repeat;touch-action:none}[_nghost-%COMP%]   .svgroot[_ngcontent-%COMP%]   .wb_element[_ngcontent-%COMP%], [_nghost-%COMP%]   .svgroot[_ngcontent-%COMP%]   .selectorGroup[_ngcontent-%COMP%]{transform-box:fill-box;transform-origin:center}[_nghost-%COMP%]   .svgroot[_ngcontent-%COMP%]   .text[_ngcontent-%COMP%]{font-family:Arial,Helvetica,sans-serif}[_nghost-%COMP%]   .svgroot.drawing[_ngcontent-%COMP%]{cursor:url(cursor.2cb01084080421f1.svg) 5 5,crosshair}[_nghost-%COMP%]   .svgroot[_ngcontent-%COMP%]   .handlers[_ngcontent-%COMP%]{display:none}[_nghost-%COMP%]   .svgroot[_ngcontent-%COMP%]   .onMove[_ngcontent-%COMP%]{cursor:move}[_nghost-%COMP%]   .svgroot[_ngcontent-%COMP%]   .onMove[_ngcontent-%COMP%]   .handlers[_ngcontent-%COMP%]{display:block}[_nghost-%COMP%]   .hand[_ngcontent-%COMP%]{cursor:grab}[_nghost-%COMP%]   .select[_ngcontent-%COMP%]{cursor:default}[_nghost-%COMP%]   .pen[_ngcontent-%COMP%]{cursor:url(pencil.fc7581cdb8f7bec4.svg) 1 18,crosshair}[_nghost-%COMP%]   .image[_ngcontent-%COMP%]{cursor:copy}[_nghost-%COMP%]   .line[_ngcontent-%COMP%]{cursor:crosshair}[_nghost-%COMP%]   .arrow[_ngcontent-%COMP%]{cursor:crosshair}[_nghost-%COMP%]   .rectangle[_ngcontent-%COMP%]{cursor:crosshair}[_nghost-%COMP%]   .ellipse[_ngcontent-%COMP%]{cursor:crosshair}[_nghost-%COMP%]   .text[_ngcontent-%COMP%]{cursor:text}[_nghost-%COMP%]   .eraser[_ngcontent-%COMP%]{cursor:url(eraser.ab38a28a2aaa11bd.svg) 0 12,crosshair}[_nghost-%COMP%]   .select[_ngcontent-%COMP%]   .wb_element[_ngcontent-%COMP%]{cursor:pointer}.text-input[_ngcontent-%COMP%]{display:none;position:absolute;background:transparent;border:1px dashed #0b89f0;outline:none;font-size:inherit;font-family:inherit;min-width:5ch;width:5ch;height:2ch;padding:0;pointer-events:auto;z-index:5;transform-origin:top left}"],changeDetection:0})}}return n})()},5149:(lt,z,f)=>{f.d(z,{K:()=>Dt});var O=f(1413),r=f(4412),V=f(8359),j=f(9974),x=f(4360),ht=f(7908);class kt extends V.yU{constructor(m,c){super()}schedule(m,c=0){return this}}const et={setInterval(I,m,...c){const{delegate:d}=et;return d?.setInterval?d.setInterval(I,m,...c):setInterval(I,m,...c)},clearInterval(I){const{delegate:m}=et;return(m?.clearInterval||clearInterval)(I)},delegate:void 0},ct={now:()=>(ct.delegate||Date).now(),delegate:void 0};class it{constructor(m,c=it.now){this.schedulerActionCtor=m,this.now=c}schedule(m,c=0,d){return new this.schedulerActionCtor(this,m).schedule(d,c)}}it.now=ct.now;const w=new class Tt extends it{constructor(m,c=it.now){super(m,c),this.actions=[],this._active=!1}flush(m){const{actions:c}=this;if(this._active)return void c.push(m);let d;this._active=!0;do{if(d=m.execute(m.state,m.delay))break}while(m=c.shift());if(this._active=!1,d){for(;m=c.shift();)m.unsubscribe();throw d}}}(class mt extends kt{constructor(m,c){super(m,c),this.scheduler=m,this.work=c,this.pending=!1}schedule(m,c=0){var d;if(this.closed)return this;this.state=m;const g=this.id,B=this.scheduler;return null!=g&&(this.id=this.recycleAsyncId(B,g,c)),this.pending=!0,this.delay=c,this.id=null!==(d=this.id)&&void 0!==d?d:this.requestAsyncId(B,this.id,c),this}requestAsyncId(m,c,d=0){return et.setInterval(m.flush.bind(m,this),d)}recycleAsyncId(m,c,d=0){if(null!=d&&this.delay===d&&!1===this.pending)return c;null!=c&&et.clearInterval(c)}execute(m,c){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;const d=this._execute(m,c);if(d)return d;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(m,c){let g,d=!1;try{this.work(m)}catch(B){d=!0,g=B||new Error("Scheduled action threw falsy error")}if(d)return this.unsubscribe(),g}unsubscribe(){if(!this.closed){const{id:m,scheduler:c}=this,{actions:d}=c;this.work=this.state=this.scheduler=null,this.pending=!1,(0,ht.o)(d,this),null!=m&&(this.id=this.recycleAsyncId(c,m,null)),this.delay=null,super.unsubscribe()}}});var J=f(3794),Bt=f(5225),Nt=f(5964),b=f(3052),Ut=f(6078),Yt=f(7879),Gt=f(4438);let Dt=(()=>{class I{constructor(){this.BUFFER_SIZE=1e3,this.BATCH_INTERVAL=16,this.actionDispatcher=new O.B,this.priorityDispatcher=new r.t([]),this.actionBuffer=[],this.actions$=this.actionDispatcher.pipe(function zt(I,...m){var c,d;const g=null!==(c=(0,J.lI)(m))&&void 0!==c?c:w,B=null!==(d=m[0])&&void 0!==d?d:null,Q=m[1]||1/0;return(0,j.N)((Y,G)=>{let F=[],pt=!1;const dt=_=>{const{buffer:ut,subs:L}=_;L.unsubscribe(),(0,ht.o)(F,_),G.next(ut),pt&&yt()},yt=()=>{if(F){const _=new V.yU;G.add(_);const L={buffer:[],subs:_};F.push(L),(0,Bt.N)(_,g,()=>dt(L),I)}};null!==B&&B>=0?(0,Bt.N)(G,g,yt,B,!0):pt=!0,yt();const nt=(0,x._)(G,_=>{const ut=F.slice();for(const L of ut){const{buffer:Rt}=L;Rt.push(_),Q<=Rt.length&&dt(L)}},()=>{for(;F?.length;)G.next(F.shift().buffer);nt?.unsubscribe(),G.complete(),G.unsubscribe()},void 0,()=>F=null);Y.subscribe(nt)})}(this.BATCH_INTERVAL),(0,Nt.p)(c=>c.length>0)),this.isProcessing=!1}addElement(c){this.dispatchWithPriority({type:b.X.AddElement,payload:{element:c}},"normal")}addImage(c,d,g){this.dispatchWithPriority({type:b.X.AddImage,payload:{image:c,x:d,y:g}},"normal")}centerCanvas(){this.dispatchWithPriority({type:b.X.CenterCanvas},"normal")}clear(){this.dispatchWithPriority({type:b.X.Clear},"high")}dispatchBatch(c){this.dispatchWithPriority({type:b.X.Batch,payload:c},"low")}fullScreen(){this.dispatchWithPriority({type:b.X.FullScreen},"normal")}removeElements(c){this.dispatchWithPriority({type:b.X.RemoveElements,payload:{ids:c}},"normal")}undo(){this.dispatchWithPriority({type:b.X.Undo},"high")}redo(){this.dispatchWithPriority({type:b.X.Redo},"high")}save(c=Ut.o8.Base64,d="New board"){this.dispatchWithPriority({type:b.X.Save,payload:{format:c,name:d}},"normal")}selectElements(c){this.dispatchWithPriority({type:b.X.SelectElements,payload:{elementsOrIds:c}},"normal")}deselectElement(c){this.dispatchWithPriority({type:b.X.DeselectElement,payload:{elementOrId:c}},"normal")}toggleSelection(c){this.dispatchWithPriority({type:b.X.ToggleSelection,payload:{elementOrId:c}},"normal")}selectAll(){this.dispatchWithPriority({type:b.X.SelectAll},"normal")}clearSelection(){this.dispatchWithPriority({type:b.X.ClearSelection},"normal")}setActiveTool(c){this.dispatchWithPriority({type:b.X.SetActiveTool,payload:{tool:c}},"normal")}setCanvasDimensions(c,d){this.dispatchWithPriority({type:b.X.SetCanvasDimensions,payload:{width:c,height:d}},"normal")}setCanvasPosition(c,d){this.dispatchWithPriority({type:b.X.SetCanvasPosition,payload:{x:c,y:d}},"normal")}toggleGrid(){this.dispatchWithPriority({type:b.X.ToggleGrid},"normal")}updateElement(c){this.dispatchWithPriority({type:b.X.UpdateElement,payload:{element:c}},"normal")}updateSelectedElements(c){this.dispatchWithPriority({type:b.X.UpdateSelectedElements,payload:{partialElement:c}},"normal")}dispatchWithPriority(c,d="normal"){const g=this.priorityDispatcher.value,B={action:c,priority:d},Q=g.findIndex(G=>this.getPriorityWeight(G.priority)<this.getPriorityWeight(d)),Y=-1===Q?[...g,B]:[...g.slice(0,Q),B,...g.slice(Q)];this.priorityDispatcher.next(Y),this.isProcessing||this.processNextAction()}dispatch(c){this.manageBuffer(c),this.actionDispatcher.next(c)}getPriorityWeight(c){return Yt.bO[c]}manageBuffer(c){this.actionBuffer.length>=this.BUFFER_SIZE&&this.actionBuffer.shift(),this.actionBuffer.push(c)}processNextAction(){if(this.isProcessing)return;this.isProcessing=!0;const c=()=>{const d=this.priorityDispatcher.value;if(d.length>0){const{action:g}=d[0];this.dispatch(g),this.priorityDispatcher.next(d.slice(1)),c()}else this.isProcessing=!1};c()}static{this.\u0275fac=function(d){return new(d||I)}}static{this.\u0275prov=Gt.jDH({token:I,factory:I.\u0275fac,providedIn:"root"})}}return I})()}}]);